package com.vijayi.services;

import java.time.LocalDateTime;
import java.util.Collections;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.vijayi.entities.Comment;
import com.vijayi.entities.User;
import com.vijayi.repositories.CommentRepository;
import com.vijayi.repositories.UserRepository;

import jakarta.transaction.Transactional;
@Service
public class CommentServiceImpl implements CommentService {

	@Autowired
    private UserRepository userRepository;
    
    @Autowired
    private CommentRepository commentRepository;
	
	@Override
	public void addComment(String commentFrom, String commentTo, String message) {

	    // Check if the 'commentTo' user exists
	    User userTo = userRepository.findByCommentTo(commentTo);
	    if (userTo == null) {
	        userTo = new User();
	        userTo.setCommentFrom(commentTo);
	        userTo.setCommentTo(commentTo);
	        userRepository.save(userTo);
	    }

	    // Check if the 'commentFrom' user exists
	    User userFrom = userRepository.findByCommentFrom(commentFrom);
	    if (userFrom == null) {
	        userFrom = new User();
	        userFrom.setCommentFrom(commentFrom);
	        userFrom.setCommentTo(commentTo);
	        userRepository.save(userFrom);
	    }

	    // Create the comment and set the appropriate relationships
	    Comment comment = new Comment();
	    comment.setMessage(message);
	    comment.setCommentDateTime(LocalDateTime.now());
	    comment.setPostedByUser(userFrom);
	    commentRepository.save(comment);
	}



	@Override
	public List<Comment> getComments(String commentTo) {
		
		User user = userRepository.findByCommentTo(commentTo);
        if (user != null) {
            return commentRepository.findByPostedByUser(user);
        }
        return Collections.emptyList();
	}

}
